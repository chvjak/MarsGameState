<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />

    <title></title>
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="code.js"></script>
    <script>
        GAME_ID = document.location.pathname;

        roles = ["Alex", "Brice", "Francis", "Glen", "Mason", "Shane"]
        prevGameState = null;
        gameState = null;

        document.addEventListener('DOMContentLoaded',
            async function () {
                roles.forEach(e => addRole(e));

                await updatePosition()
                setInterval(updatePosition, 2000);
            })

        function addRole(e) {
            opt = document.createElement("option");
            opt.text = e;
            opt.innerHtml = e;

            opt.onclick = submitRole

            $("#role")[0].appendChild(opt)
        }

        function updateRoles(gameState) {
            gameState.RolesDistribution.forEach(function (e, i) {
                selectControl = $("#role")[0];
                for (var i = 0; i < selectControl.options.length; i++) {
                    if (gameState.PlayerName == e.PlayerName) {
                        selectControl.options[i].selected = (selectControl.options[i].value == e.Role)
                    }
                    else
                        selectControl.options[i].disabled = (selectControl.options[i].value == e.Role)
                }
            })
        }

        function updateRoles2(gameState) {
            console.log("updateRoles2:10")
            $("#player_role tr").remove();

            console.log("updateRoles2:20")
            gameState.RolesDistribution.forEach(function (e, i) {
                console.log("updateRoles2:30" + e)
                var $tr = $('<tr>').append(
                    $('<td>').text(e.PlayerName),
                    $('<td>').text(e.Role)
                ).appendTo("#player_role");

            })
        }

        async function submitRole() {
            let formData = new FormData()
            formData.append('role', $("#role")[0].value)

            let url = window.location;
            console.log("Posting role info to " + url)
            var response = await fetch(url, {
                method: 'POST',
                body: formData
            }).catch(() => alert("Error fetching data"));

            await response.text()
        }

        async function updatePosition() {

            let url = window.location + "?action=GET_POSITION";
            var response = await fetch(url, {
                method: 'GET'
            }).catch(() => alert("Error fetching data"));

            prevGameState = gameState;
            gameState = JSON.parse(await response.text());

            $("#player_name")[0].innerText = gameState.PlayerName;

            updateRoles(gameState)
            updateRoles2(gameState)

            $("#game_log").text("")
            gameState.GameLogRecords.forEach(function (e, i) {
                $("#game_log").append($("<div>").text(e.Timestamp + ": " + e.Message))
            })

            console.log(JSON.stringify(gameState))

            if (prevGameState != null && gameState != null) {
                if (prevGameState.GameChapter != gameState.GameChapter) {
                    console.log("Game chapter has changed. Trying to refresh...")
                    window.location = window.location;
                }
            }
        }

        async function nextChapter() {
            let formData = new FormData()
            formData.append('chapter', 2) // TODO: if games was paused it could be different chapter

            let url = window.location;
            console.log("Posting chapter info to " + url)
            var response = await fetch(url, {
                method: 'POST',
                body: formData
            }).catch(() => alert("Error fetching data"));

            await response.text()
            await updatePosition()
        }
    </script>
</head>
<body>
    Player name:<span id="player_name"></span><br><br>

    <form method="POST" id="form1" name="form1">
        Select role(s):<br>
        <select name=role id=role size=10></select><br><br>

        <table id="player_role">
            <tr>
                <th>
                    Player
                </th>
                <th>
                    Role
                </th>
            </tr>
        </table>

        <br>

        <div id="game_log">
        </div>

        <br>

        <input type="button" value="Next Chapter" onclick="nextChapter()">
    </form>
</body>
</html>